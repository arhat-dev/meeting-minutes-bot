golang:test:
- name: app
  env:
  - name: PROFILE_DIR
    value@tpl: |-
      {{- fs.Join dukkha.WorkDir "build" "test-profile" -}}

  matrix:
    pkg@tpl: |-
      {{-
        (eval.Shell "go list ./pkg/...").Stdout
        | removePrefix ((eval.Shell "go list -m").Stdout | trimSpace)
        | removePrefix "/"
        | addPrefix "- "
      -}}
  hooks:
    before:
    - shell: tpl:mkdir -p "${PROFILE_DIR}" >/dev/null

  tags:
  - timetzdata

  __@tpl#use-spec:
    template: |-
      {{- include "golang.test.pkg" . -}}
    include:
    - path@presets#cached-file: golang/test/pkg.yml
    variables:
      profile_dir@tpl: |-
        {{- env.PROFILE_DIR -}}
      cover_pkg: ./...
